name: Production Tests - Stack Configuration Validation

on:
  push:
    branches: [ main ]
  schedule:
    # Run production validation every 6 hours
    - cron: '0 */6 * * *'

env:
  PYTHON_VERSION: '3.11'
  API_BASE_URL: 'https://api.gatewayz.ai'

jobs:
  configuration-tests:
    name: Stack Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Collect all tests
        run: |
          pytest tests/test_stack_configuration.py -v --collect-only

      - name: Run configuration validation tests
        run: |
          pytest tests/test_stack_configuration.py -v --tb=short -x

      - name: Run tests with coverage report
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing

      - name: Check code coverage thresholds
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          coverage = float(root.get('line-rate', 0)) * 100
          print(f'Code coverage: {coverage:.1f}%')
          if coverage < 50:
              print('âš ï¸ Warning: Coverage below 50% threshold')
          else:
              print('âœ… Coverage meets threshold')
          "

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: production
          name: stack-configuration-production

  docker-validation:
    name: Docker Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker-compose config --quiet
          echo "âœ… docker-compose.yml is valid"

      - name: Check all Dockerfiles exist
        run: |
          for service in prometheus loki tempo grafana mimir; do
            if [ -f "$service/Dockerfile" ]; then
              echo "âœ… $service/Dockerfile found"
            else
              echo "âŒ $service/Dockerfile not found"
              exit 1
            fi
          done

      - name: Check Prometheus entrypoint.sh exists
        run: |
          if [ -f "prometheus/entrypoint.sh" ]; then
            echo "âœ… prometheus/entrypoint.sh found"
            # Verify it handles Mimir URL substitution
            if grep -q "MIMIR_URL" prometheus/entrypoint.sh; then
              echo "âœ… Entrypoint handles MIMIR_URL substitution"
            else
              echo "âŒ Entrypoint missing MIMIR_URL substitution"
              exit 1
            fi
          else
            echo "âŒ prometheus/entrypoint.sh not found"
            exit 1
          fi

  yaml-validation:
    name: YAML Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: |
          pip install PyYAML

      - name: Validate Prometheus configuration
        run: |
          python -c "
          import yaml
          with open('prometheus/prometheus.yml') as f:
              config = yaml.safe_load(f)
          assert 'scrape_configs' in config, 'Missing scrape_configs'
          print('âœ… prometheus/prom.yml is valid')
          "

      - name: Validate Loki configuration
        run: |
          python -c "
          import yaml
          with open('loki/loki.yml') as f:
              config = yaml.safe_load(f)
          assert 'server' in config, 'Missing server section'
          print('âœ… loki/loki.yml is valid')
          "

      - name: Validate Tempo configuration
        run: |
          python -c "
          import yaml
          with open('tempo/tempo.yml') as f:
              config = yaml.safe_load(f)
          assert 'server' in config, 'Missing server section'
          print('âœ… tempo/tempo.yml is valid')
          "

      - name: Validate docker-compose.yml
        run: |
          python -c "
          import yaml
          with open('docker-compose.yml') as f:
              config = yaml.safe_load(f)
          assert 'services' in config, 'Missing services'
          assert 'mimir' in config['services'], 'Missing mimir service'
          print('âœ… docker-compose.yml is valid')
          "

      - name: Validate Mimir configuration
        run: |
          python -c "
          import yaml
          # Validate mimir-railway.yml (production config)
          with open('mimir/mimir-railway.yml') as f:
              config = yaml.safe_load(f)
          assert 'server' in config, 'Missing server section'
          assert config['server']['http_listen_port'] == 9009, 'Mimir should listen on 9009'
          assert config.get('target') == 'all', 'Mimir should be in monolithic mode'
          assert config.get('multitenancy_enabled') is False, 'Multitenancy should be disabled'
          assert 'blocks_storage' in config, 'Missing blocks_storage'
          assert 'limits' in config, 'Missing limits'
          print('âœ… mimir/mimir-railway.yml is valid')

          # Validate mimir.yml (local config)
          with open('mimir/mimir.yml') as f:
              config = yaml.safe_load(f)
          assert 'server' in config, 'Missing server section'
          print('âœ… mimir/mimir.yml is valid')
          "

      - name: Validate Prometheus remote_write to Mimir
        run: |
          python -c "
          import yaml
          with open('prometheus/prometheus.yml') as f:
              config = yaml.safe_load(f)
          assert 'remote_write' in config, 'Missing remote_write'
          remote_write = config['remote_write']
          assert len(remote_write) > 0, 'remote_write is empty'
          assert remote_write[0].get('name') == 'mimir-remote-write', 'First remote_write should be mimir-remote-write'
          assert 'api/v1/push' in remote_write[0].get('url', ''), 'Missing api/v1/push endpoint'
          print('âœ… Prometheus remote_write to Mimir is configured')
          "

      - name: Validate Grafana Mimir datasource
        run: |
          python -c "
          import yaml
          with open('grafana/provisioning/datasources/mimir.yml') as f:
              config = yaml.safe_load(f)
          assert 'datasources' in config, 'Missing datasources section'
          ds = config['datasources'][0]
          assert ds.get('name') == 'Mimir', 'Datasource should be named Mimir'
          assert ds.get('type') == 'prometheus', 'Mimir datasource type should be prometheus'
          print('âœ… Grafana Mimir datasource is configured')
          "

  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      - name: Check backend metrics endpoint
        env:
          API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
        run: |
          python << 'EOF'
          import asyncio
          import httpx
          import os
          from datetime import datetime

          async def health_check():
              backend_url = 'https://api.gatewayz.ai'
              mimir_url = 'https://mimir-production-1b34.up.railway.app'
              api_key = os.getenv('API_KEY', '')
              print(f"\nðŸ“Š Production Health Check - {datetime.now().isoformat()}")
              print("=" * 60)

              async with httpx.AsyncClient() as client:
                  # Check Mimir health (public endpoint, no auth required)
                  try:
                      response = await client.get(
                          f'{mimir_url}/ready',
                          timeout=10
                      )
                      if response.status_code == 200:
                          print("âœ… Mimir /ready endpoint: UP")
                      else:
                          print(f"âš ï¸ Mimir /ready endpoint: {response.status_code}")
                  except Exception as e:
                      print(f"âš ï¸ Mimir /ready endpoint: {str(e)[:80]}")

                  # Check Mimir can query metrics
                  try:
                      response = await client.get(
                          f'{mimir_url}/prometheus/api/v1/labels',
                          timeout=10
                      )
                      if response.status_code == 200:
                          print("âœ… Mimir query endpoint: UP")
                      else:
                          print(f"âš ï¸ Mimir query endpoint: {response.status_code}")
                  except Exception as e:
                      print(f"âš ï¸ Mimir query endpoint: {str(e)[:80]}")

                  # Check backend metrics (requires auth)
                  if not api_key:
                      print("âš ï¸ API_KEY not configured - skipping backend endpoint tests")
                      return

                  try:
                      response = await client.get(
                          f'{backend_url}/metrics',
                          timeout=10,
                          headers={"Authorization": f"Bearer {api_key}"}
                      )
                      if response.status_code == 200:
                          print("âœ… Backend /metrics endpoint: UP")
                          print(f"   Response size: {len(response.text)} bytes")
                      else:
                          print(f"âš ï¸ Backend /metrics endpoint: {response.status_code}")
                  except Exception as e:
                      print(f"âš ï¸ Backend /metrics endpoint: {str(e)[:80]}")

          asyncio.run(health_check())
          EOF

  endpoint-tests:
    name: API Endpoint Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run API endpoint tests
        env:
          API_KEY: ${{ secrets.PRODUCTION_API_KEY }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: |
          if [ -z "$API_KEY" ]; then
            echo "âš ï¸ API_KEY not configured - skipping endpoint tests"
            echo "To enable endpoint testing, add PRODUCTION_API_KEY to GitHub Secrets"
          else
            pytest tests/test_api_endpoints.py -v --tb=short -m endpoint
          fi

  dashboard-tests:
    name: Dashboard Validation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run dashboard structure validation
        run: |
          pytest tests/test_dashboards.py -v --tb=short -m dashboard

      - name: Run dashboard validation script
        run: |
          chmod +x scripts/validate_dashboards.sh
          ./scripts/validate_dashboards.sh

  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [configuration-tests, docker-validation, yaml-validation, endpoint-tests, dashboard-tests]
    if: always()

    steps:
      - name: Generate test report
        run: |
          echo "## ðŸ“‹ Production Test Report"
          echo ""
          echo "### Test Execution Summary"
          echo "- Configuration Tests: ${{ needs.configuration-tests.result }}"
          echo "- Docker Validation: ${{ needs.docker-validation.result }}"
          echo "- YAML Validation: ${{ needs.yaml-validation.result }}"
          echo "- Endpoint Tests: ${{ needs.endpoint-tests.result }}"
          echo "- Dashboard Tests: ${{ needs.dashboard-tests.result }}"
          echo ""
          echo "### Components Tested"
          echo "- Stack configuration files (YAML)"
          echo "- Docker Compose setup"
          echo "- Prometheus scrape configuration and remote_write to Mimir"
          echo "- Mimir long-term metrics storage configuration"
          echo "- Loki and Tempo configuration"
          echo "- Grafana datasources (Prometheus, Mimir, Loki, Tempo)"
          echo "- All 22 real API endpoints (with API key)"
          echo "- Dashboard JSON structure and naming conventions"
          echo "- Mimir health check (/ready and query endpoints)"
          echo ""
          echo "### Status"
          if [ "${{ needs.configuration-tests.result }}" == "success" ] && \
             [ "${{ needs.docker-validation.result }}" == "success" ] && \
             [ "${{ needs.yaml-validation.result }}" == "success" ] && \
             [ "${{ needs.endpoint-tests.result }}" == "success" ] && \
             [ "${{ needs.dashboard-tests.result }}" == "success" ]; then
            echo "âœ… All production tests passed"
          else
            echo "âš ï¸ Some tests failed - review details above"
          fi
