name: Production Tests - Stack Configuration Validation

on:
  push:
    branches: [ main ]
  schedule:
    # Run production validation every 6 hours
    - cron: '0 */6 * * *'

env:
  PYTHON_VERSION: '3.11'

jobs:
  configuration-tests:
    name: Stack Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Collect all tests
        run: |
          pytest tests/test_stack_configuration.py -v --collect-only

      - name: Run configuration validation tests
        run: |
          pytest tests/test_stack_configuration.py -v --tb=short -x

      - name: Run tests with coverage report
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing

      - name: Check code coverage thresholds
        run: |
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          coverage = float(root.get('line-rate', 0)) * 100
          print(f'Code coverage: {coverage:.1f}%')
          if coverage < 50:
              print('âš ï¸ Warning: Coverage below 50% threshold')
          else:
              print('âœ… Coverage meets threshold')
          "

      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: production
          name: stack-configuration-production

  docker-validation:
    name: Docker Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker-compose config --quiet
          echo "âœ… docker-compose.yml is valid"

      - name: Check all Dockerfiles exist
        run: |
          for service in prometheus loki tempo grafana; do
            if [ -f "$service/Dockerfile" ]; then
              echo "âœ… $service/Dockerfile found"
            else
              echo "âŒ $service/Dockerfile not found"
              exit 1
            fi
          done

  yaml-validation:
    name: YAML Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: |
          pip install PyYAML

      - name: Validate Prometheus configuration
        run: |
          python -c "
          import yaml
          with open('prometheus/prom.yml') as f:
              config = yaml.safe_load(f)
          assert 'scrape_configs' in config, 'Missing scrape_configs'
          print('âœ… prometheus/prom.yml is valid')
          "

      - name: Validate Loki configuration
        run: |
          python -c "
          import yaml
          with open('loki/loki.yml') as f:
              config = yaml.safe_load(f)
          assert 'server' in config, 'Missing server section'
          print('âœ… loki/loki.yml is valid')
          "

      - name: Validate Tempo configuration
        run: |
          python -c "
          import yaml
          with open('tempo/tempo.yml') as f:
              config = yaml.safe_load(f)
          assert 'server' in config, 'Missing server section'
          print('âœ… tempo/tempo.yml is valid')
          "

      - name: Validate docker-compose.yml
        run: |
          python -c "
          import yaml
          with open('docker-compose.yml') as f:
              config = yaml.safe_load(f)
          assert 'services' in config, 'Missing services'
          print('âœ… docker-compose.yml is valid')
          "

  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install httpx

      - name: Check backend metrics endpoint
        run: |
          python << 'EOF'
          import asyncio
          import httpx
          from datetime import datetime

          async def health_check():
              backend_url = 'https://gatewayz-staging.up.railway.app'
              print(f"\nðŸ“Š Production Health Check - {datetime.now().isoformat()}")
              print("=" * 60)

              async with httpx.AsyncClient() as client:
                  # Check metrics endpoint
                  try:
                      response = await client.get(
                          f'{backend_url}/metrics',
                          timeout=10,
                          headers={"Authorization": "Bearer gw_live_wTfpLJ5VB28qMXpOAhr7Uw"}
                      )
                      if response.status_code == 200:
                          print("âœ… Backend /metrics endpoint: UP")
                          print(f"   Response size: {len(response.text)} bytes")
                      else:
                          print(f"âš ï¸ Backend /metrics endpoint: {response.status_code}")
                  except Exception as e:
                      print(f"âš ï¸ Backend /metrics endpoint: {str(e)[:80]}")

          asyncio.run(health_check())
          EOF

  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [configuration-tests, docker-validation, yaml-validation]
    if: always()

    steps:
      - name: Generate test report
        run: |
          echo "## ðŸ“‹ Production Test Report"
          echo ""
          echo "### Test Execution Summary"
          echo "- Configuration Tests: ${{ needs.configuration-tests.result }}"
          echo "- Docker Validation: ${{ needs.docker-validation.result }}"
          echo "- YAML Validation: ${{ needs.yaml-validation.result }}"
          echo ""
          echo "### Components Tested"
          echo "- Stack configuration files (YAML)"
          echo "- Docker Compose setup"
          echo "- Prometheus scrape configuration"
          echo "- Loki and Tempo configuration"
          echo "- Grafana datasources and dashboards"
          echo ""
          echo "### Status"
          if [ "${{ needs.configuration-tests.result }}" == "success" ] && \
             [ "${{ needs.docker-validation.result }}" == "success" ] && \
             [ "${{ needs.yaml-validation.result }}" == "success" ]; then
            echo "âœ… All production tests passed"
          else
            echo "âš ï¸ Some tests failed - review details above"
          fi
