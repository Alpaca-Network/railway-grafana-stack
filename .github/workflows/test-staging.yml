name: Staging Tests - Stack Configuration

on:
  push:
    branches: [ staging ]
  pull_request:
    branches: [ staging ]

env:
  PYTHON_VERSION: '3.11'
  API_BASE_URL: 'https://gatewayz-staging.up.railway.app'

jobs:
  configuration-tests:
    name: Staging Configuration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Collect all tests
        run: |
          pytest tests/test_stack_configuration.py -v --collect-only

      - name: Run configuration validation tests
        run: |
          pytest tests/test_stack_configuration.py -v --tb=short

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: staging
          name: stack-configuration-staging

  yaml-validation:
    name: YAML Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: |
          pip install PyYAML

      - name: Validate all YAML configurations
        run: |
          python << 'EOF'
          import yaml
          import sys

          configs = {
              'prometheus/prom.yml': 'scrape_configs',
              'loki/loki.yml': 'server',
              'tempo/tempo.yml': 'server',
              'mimir/mimir.yml': 'server',
              'mimir/mimir-railway.yml': 'server',
              'docker-compose.yml': 'services'
          }

          all_valid = True
          for config_file, required_key in configs.items():
              try:
                  with open(config_file) as f:
                      config = yaml.safe_load(f)
                  if config is None:
                      print(f'âŒ {config_file} is empty')
                      all_valid = False
                  elif required_key not in config:
                      print(f'âŒ {config_file} missing {required_key}')
                      all_valid = False
                  else:
                      print(f'âœ… {config_file} is valid')
              except Exception as e:
                  print(f'âŒ {config_file} error: {e}')
                  all_valid = False

          # Additional Mimir validations
          try:
              with open('mimir/mimir-railway.yml') as f:
                  config = yaml.safe_load(f)
              if config.get('target') != 'all':
                  print('âŒ mimir-railway.yml should have target: all')
                  all_valid = False
              if config.get('multitenancy_enabled') is not False:
                  print('âŒ mimir-railway.yml should have multitenancy_enabled: false')
                  all_valid = False
              if 'blocks_storage' not in config:
                  print('âŒ mimir-railway.yml missing blocks_storage')
                  all_valid = False
              print('âœ… mimir/mimir-railway.yml Railway-specific validations passed')
          except Exception as e:
              print(f'âŒ Mimir Railway validation error: {e}')
              all_valid = False

          # Validate Prometheus remote_write to Mimir
          try:
              with open('prometheus/prom.yml') as f:
                  config = yaml.safe_load(f)
              if 'remote_write' not in config:
                  print('âŒ prometheus/prom.yml missing remote_write')
                  all_valid = False
              elif len(config['remote_write']) == 0:
                  print('âŒ prometheus/prom.yml remote_write is empty')
                  all_valid = False
              elif config['remote_write'][0].get('name') != 'mimir-remote-write':
                  print('âŒ prometheus/prom.yml first remote_write should be mimir-remote-write')
                  all_valid = False
              else:
                  print('âœ… Prometheus remote_write to Mimir configured')
          except Exception as e:
              print(f'âŒ Prometheus remote_write validation error: {e}')
              all_valid = False

          sys.exit(0 if all_valid else 1)
          EOF

  docker-validation:
    name: Docker Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml syntax
        run: |
          docker-compose config --quiet
          echo "âœ… docker-compose.yml is valid"

      - name: Check all service Dockerfiles
        run: |
          for service in prometheus loki tempo grafana mimir; do
            if [ -f "$service/Dockerfile" ]; then
              echo "âœ… $service/Dockerfile found"
            else
              echo "âŒ $service/Dockerfile missing"
              exit 1
            fi
          done

      - name: Check Prometheus entrypoint.sh exists
        run: |
          if [ -f "prometheus/entrypoint.sh" ]; then
            echo "âœ… prometheus/entrypoint.sh found"
            # Verify it handles Mimir URL substitution
            if grep -q "MIMIR_URL" prometheus/entrypoint.sh; then
              echo "âœ… Entrypoint handles MIMIR_URL substitution"
            else
              echo "âŒ Entrypoint missing MIMIR_URL substitution"
              exit 1
            fi
          else
            echo "âŒ prometheus/entrypoint.sh not found"
            exit 1
          fi

  endpoint-tests:
    name: API Endpoint Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run API endpoint tests
        env:
          API_KEY: ${{ secrets.STAGING_API_KEY }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: |
          if [ -z "$API_KEY" ]; then
            echo "âš ï¸ API_KEY not configured - skipping endpoint tests"
            echo "To enable endpoint testing, add STAGING_API_KEY to GitHub Secrets"
          else
            pytest tests/test_api_endpoints.py -v --tb=short -m endpoint
          fi

  dashboard-tests:
    name: Dashboard Validation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run dashboard structure validation
        run: |
          pytest tests/test_dashboards.py -v --tb=short -m dashboard

      - name: Run dashboard validation script
        run: |
          chmod +x scripts/validate_dashboards.sh
          ./scripts/validate_dashboards.sh

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [configuration-tests, yaml-validation, docker-validation, endpoint-tests, dashboard-tests]
    if: always()

    steps:
      - name: Report test status
        run: |
          echo "## ðŸ“‹ Staging Test Summary"
          echo ""
          echo "### Test Results"
          echo "- Configuration Tests: ${{ needs.configuration-tests.result }}"
          echo "- YAML Validation: ${{ needs.yaml-validation.result }}"
          echo "- Docker Validation: ${{ needs.docker-validation.result }}"
          echo "- Endpoint Tests: ${{ needs.endpoint-tests.result }}"
          echo "- Dashboard Tests: ${{ needs.dashboard-tests.result }}"
          echo ""
          echo "### Components Validated"
          echo "- Stack configuration files (YAML)"
          echo "- Docker Compose setup"
          echo "- Service Dockerfiles (prometheus, loki, tempo, grafana, mimir)"
          echo "- Mimir long-term metrics storage configuration"
          echo "- Prometheus remote_write to Mimir"
          echo "- Configuration consistency"
          echo "- All 22 real API endpoints (with API key)"
          echo "- Dashboard JSON structure and naming conventions"
          echo ""
          if [ "${{ needs.configuration-tests.result }}" == "success" ] && \
             [ "${{ needs.yaml-validation.result }}" == "success" ] && \
             [ "${{ needs.docker-validation.result }}" == "success" ] && \
             [ "${{ needs.endpoint-tests.result }}" == "success" ] && \
             [ "${{ needs.dashboard-tests.result }}" == "success" ]; then
            echo "âœ… All staging tests passed"
          else
            echo "âš ï¸ Some tests failed - review details above"
          fi
