name: Staging Tests - Stack Configuration

on:
  push:
    branches: [ staging ]
  pull_request:
    branches: [ staging ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  configuration-tests:
    name: Staging Configuration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Collect all tests
        run: |
          pytest tests/test_stack_configuration.py -v --collect-only

      - name: Run configuration validation tests
        run: |
          pytest tests/test_stack_configuration.py -v --tb=short

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: staging
          name: stack-configuration-staging

  yaml-validation:
    name: YAML Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: |
          pip install PyYAML

      - name: Validate all YAML configurations
        run: |
          python << 'EOF'
          import yaml
          import sys

          configs = {
              'prometheus/prom.yml': 'scrape_configs',
              'loki/loki.yml': 'server',
              'tempo/tempo.yml': 'server',
              'docker-compose.yml': 'services'
          }

          all_valid = True
          for config_file, required_key in configs.items():
              try:
                  with open(config_file) as f:
                      config = yaml.safe_load(f)
                  if config is None:
                      print(f'âŒ {config_file} is empty')
                      all_valid = False
                  elif required_key not in config:
                      print(f'âŒ {config_file} missing {required_key}')
                      all_valid = False
                  else:
                      print(f'âœ… {config_file} is valid')
              except Exception as e:
                  print(f'âŒ {config_file} error: {e}')
                  all_valid = False

          sys.exit(0 if all_valid else 1)
          EOF

  docker-validation:
    name: Docker Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml syntax
        run: |
          docker-compose config --quiet
          echo "âœ… docker-compose.yml is valid"

      - name: Check all service Dockerfiles
        run: |
          for service in prometheus loki tempo grafana; do
            if [ -f "$service/Dockerfile" ]; then
              echo "âœ… $service/Dockerfile found"
            else
              echo "âŒ $service/Dockerfile missing"
              exit 1
            fi
          done

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [configuration-tests, yaml-validation, docker-validation]
    if: always()

    steps:
      - name: Report test status
        run: |
          echo "## ðŸ“‹ Staging Test Summary"
          echo ""
          echo "### Test Results"
          echo "- Configuration Tests: ${{ needs.configuration-tests.result }}"
          echo "- YAML Validation: ${{ needs.yaml-validation.result }}"
          echo "- Docker Validation: ${{ needs.docker-validation.result }}"
          echo ""
          echo "### Components Validated"
          echo "- Stack configuration files (YAML)"
          echo "- Docker Compose setup"
          echo "- Service Dockerfiles"
          echo "- Configuration consistency"
          echo ""
          if [ "${{ needs.configuration-tests.result }}" == "success" ] && \
             [ "${{ needs.yaml-validation.result }}" == "success" ] && \
             [ "${{ needs.docker-validation.result }}" == "success" ]; then
            echo "âœ… All staging tests passed"
          else
            echo "âš ï¸ Some tests failed - review details above"
          fi
