{
  "title": "GatewayZ ‚Äî Cache & Redis CPU Profile",
  "uid": "gatewayz-cache-layer-profile",
  "description": "Pyroscope CPU breakdown of every Redis/cache operation in the gateway. Each operation is tagged with cache_layer (auth, rate_limit, model_catalog, response_cache, trial_analytics) and cache_op (read, write, delete) ‚Äî making it possible to answer: 'Is Redis actually hurting us, and which layer is to blame?'",
  "tags": ["profiling", "pyroscope", "redis", "cache", "performance"],
  "schemaVersion": 39,
  "version": 1,
  "refresh": "30s",
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "panels": [
    {
      "id": 1,
      "type": "row",
      "title": "üîç Cache CPU Flamegraph ‚Äî What is Redis actually doing?",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 }
    },
    {
      "id": 2,
      "type": "text",
      "title": "",
      "gridPos": { "x": 0, "y": 1, "w": 24, "h": 2 },
      "options": {
        "mode": "markdown",
        "content": "**How to read this dashboard:** Each flamegraph sample was captured while the process was inside a `pyroscope.tag_wrapper(cache_layer=..., cache_op=...)` block ‚Äî meaning only stack frames executing a Redis operation are shown. A tall, wide block means that cache layer consumed significant CPU. Filter by layer or operation using the variables above to isolate exactly which call is costly."
      }
    },
    {
      "id": 3,
      "type": "flamegraph",
      "title": "Cache Operation CPU Flamegraph",
      "description": "CPU stack samples taken while inside a Redis/cache operation. Filter by cache_layer (auth, rate_limit, model_catalog, response_cache, trial_analytics) and cache_op (read, write, delete) to zoom in on the expensive path.",
      "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
      "gridPos": { "x": 0, "y": 3, "w": 24, "h": 16 },
      "options": {
        "collapseConfig": false,
        "disableCollapsing": false,
        "disableFocusOnClick": false,
        "disableTooltip": false,
        "extraColors": false,
        "keepDisplayedInTree": false,
        "nameLocation": "topLeft"
      },
      "fieldConfig": { "defaults": {}, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "labelSelector": "{service_name=\"gatewayz-backend\",cache_layer=~\"$cache_layer\",cache_op=~\"$cache_op\"}",
          "queryType": "profile"
        }
      ]
    },
    {
      "id": 10,
      "type": "row",
      "title": "üìä CPU Cost per Cache Layer ‚Äî Which layer is the most expensive?",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 19, "w": 24, "h": 1 }
    },
    {
      "id": 11,
      "type": "bargauge",
      "title": "CPU Samples by Cache Layer",
      "description": "Total Pyroscope CPU samples attributed to each cache layer over the selected window. Higher = more CPU time spent on that layer's Redis operations. auth and rate_limit run on every request ‚Äî if they dominate, Redis latency is the bottleneck.",
      "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
      "gridPos": { "x": 0, "y": 20, "w": 12, "h": 10 },
      "options": {
        "orientation": "horizontal",
        "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false },
        "displayMode": "gradient",
        "valueMode": "color",
        "showUnfilled": true,
        "minVizWidth": 0,
        "minVizHeight": 16,
        "namePlacement": "auto",
        "text": {}
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "percentage",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 40 },
              { "color": "orange", "value": 70 },
              { "color": "red", "value": 90 }
            ]
          },
          "color": { "mode": "thresholds" }
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "labelSelector": "{service_name=\"gatewayz-backend\",cache_layer=~\"$cache_layer\",cache_op=~\"$cache_op\"}",
          "groupBy": ["cache_layer"],
          "queryType": "metrics"
        }
      ]
    },
    {
      "id": 12,
      "type": "bargauge",
      "title": "CPU Samples by Cache Operation",
      "description": "CPU samples broken down by operation type (read / write / delete). If 'read' is the biggest block and cache hit rates are high, serialisation/deserialisation is the real cost ‚Äî not the network round-trip.",
      "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
      "gridPos": { "x": 12, "y": 20, "w": 12, "h": 10 },
      "options": {
        "orientation": "horizontal",
        "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false },
        "displayMode": "gradient",
        "valueMode": "color",
        "showUnfilled": true,
        "minVizWidth": 0,
        "minVizHeight": 16,
        "namePlacement": "auto",
        "text": {}
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {
            "mode": "percentage",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 40 },
              { "color": "orange", "value": 70 },
              { "color": "red", "value": 90 }
            ]
          },
          "color": { "mode": "thresholds" }
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "labelSelector": "{service_name=\"gatewayz-backend\",cache_layer=~\"$cache_layer\",cache_op=~\"$cache_op\"}",
          "groupBy": ["cache_op"],
          "queryType": "metrics"
        }
      ]
    },
    {
      "id": 20,
      "type": "row",
      "title": "‚è±Ô∏è Cache CPU Rate Over Time ‚Äî Spot spikes and correlate with traffic",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 30, "w": 24, "h": 1 }
    },
    {
      "id": 21,
      "type": "timeseries",
      "title": "Cache CPU Sample Rate ‚Äî by Layer",
      "description": "Pyroscope sample rate (samples/sec) over time coloured by cache_layer. A spike in 'rate_limit' during high traffic is expected ‚Äî a spike during low traffic suggests a misconfigured TTL or cache stampede.",
      "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
      "gridPos": { "x": 0, "y": 31, "w": 24, "h": 9 },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max", "sum"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 15,
            "showPoints": "never",
            "spanNulls": true
          },
          "color": { "mode": "palette-classic" }
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "labelSelector": "{service_name=\"gatewayz-backend\",cache_layer=~\"$cache_layer\",cache_op=~\"$cache_op\"}",
          "groupBy": ["cache_layer"],
          "queryType": "metrics"
        }
      ]
    },
    {
      "id": 22,
      "type": "timeseries",
      "title": "Cache CPU Sample Rate ‚Äî by Operation",
      "description": "Same data split by operation. Useful for understanding whether a spike is driven by reads (cache hit path) or writes (post-miss population path ‚Äî implies high miss rate and DB load).",
      "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
      "gridPos": { "x": 0, "y": 40, "w": 24, "h": 9 },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max", "sum"] }
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "lineWidth": 1,
            "fillOpacity": 15,
            "showPoints": "never",
            "spanNulls": true
          },
          "color": { "mode": "palette-classic" }
        },
        "overrides": []
      },
      "targets": [
        {
          "refId": "A",
          "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "labelSelector": "{service_name=\"gatewayz-backend\",cache_layer=~\"$cache_layer\",cache_op=~\"$cache_op\"}",
          "groupBy": ["cache_op"],
          "queryType": "metrics"
        }
      ]
    },
    {
      "id": 30,
      "type": "row",
      "title": "üî¨ Drill-Down ‚Äî Isolate a single layer + operation",
      "collapsed": false,
      "gridPos": { "x": 0, "y": 49, "w": 24, "h": 1 }
    },
    {
      "id": 31,
      "type": "flamegraph",
      "title": "Focused Flamegraph ‚Äî Selected Layer & Op",
      "description": "Use the $cache_layer and $cache_op variables to zoom into exactly one layer and operation. This reveals whether the cost is in socket I/O (redis-py network calls), JSON serialisation, or Python object allocation.",
      "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
      "gridPos": { "x": 0, "y": 50, "w": 24, "h": 16 },
      "options": {
        "collapseConfig": false,
        "disableCollapsing": false,
        "disableFocusOnClick": false,
        "disableTooltip": false,
        "extraColors": false,
        "keepDisplayedInTree": false,
        "nameLocation": "topLeft"
      },
      "fieldConfig": { "defaults": {}, "overrides": [] },
      "targets": [
        {
          "refId": "A",
          "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "labelSelector": "{service_name=\"gatewayz-backend\",cache_layer=\"$cache_layer\",cache_op=\"$cache_op\"}",
          "queryType": "profile"
        }
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "name": "cache_layer",
        "label": "Cache Layer",
        "type": "query",
        "datasource": { "uid": "grafana_pyroscope", "type": "grafana-pyroscope-datasource" },
        "query": {
          "labelSelector": "{service_name=\"gatewayz-backend\"}",
          "profileTypeId": "process_cpu:cpu:nanoseconds:cpu:nanoseconds",
          "queryType": "label_values",
          "labelName": "cache_layer"
        },
        "refresh": 2,
        "sort": 1,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      },
      {
        "name": "cache_op",
        "label": "Operation",
        "type": "custom",
        "query": "read,write,delete",
        "options": [
          { "selected": false, "text": "read",   "value": "read" },
          { "selected": false, "text": "write",  "value": "write" },
          { "selected": false, "text": "delete", "value": "delete" }
        ],
        "refresh": 0,
        "sort": 0,
        "includeAll": true,
        "allValue": ".*",
        "multi": true,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      }
    ]
  },
  "annotations": { "list": [] },
  "links": [
    {
      "title": "Inference Call Profile",
      "url": "/d/gatewayz-inference-call-profile",
      "type": "link",
      "icon": "external link",
      "tooltip": "See full inference call anatomy including this cache CPU in context"
    },
    {
      "title": "Inference Profiling (all tags)",
      "url": "/d/inference_profiling",
      "type": "link",
      "icon": "external link",
      "tooltip": "Broader flamegraph filtered by provider/model"
    }
  ]
}
