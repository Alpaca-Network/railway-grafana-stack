apiVersion: 1

notificationPolicies:
  - orgId: 1
    provenance: Grafana
    policy:
      receiver: ops-email
      groupByStr:
        - alertname
        - instance
      matchers:
        - name: alertname
          value: ''
          matchType: =~
      muteTimeIntervals: []
      routes:
        # ================================================================
        # ABNORMAL BEHAVIOR ALERTS - OBSERVATORY POOL
        # These alerts are generated from LGTM+Prometheus telemetry
        # ================================================================

        # Traffic anomalies - critical (3x+ baseline)
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: traffic_spike
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 5m
          groupWait: 10s
          muteTimeIntervals: []

        # Traffic anomalies - warning (2x baseline)
        - receiver: observatory-pool-warning
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: traffic_spike
              matchType: '='
          repeatInterval: 1h
          groupInterval: 10m
          groupWait: 30s
          muteTimeIntervals: []

        # Traffic drop alerts
        - receiver: observatory-pool-warning
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: traffic_drop
              matchType: '='
          repeatInterval: 1h
          groupInterval: 10m
          groupWait: 30s
          muteTimeIntervals: []

        # Error rate anomalies - critical
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: error_rate_spike
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 3m
          groupWait: 0s
          muteTimeIntervals: []

        # Error rate anomalies - warning
        - receiver: observatory-pool-warning
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: error_rate_spike
              matchType: '='
          repeatInterval: 30m
          groupInterval: 5m
          groupWait: 30s
          muteTimeIntervals: []

        # Server errors (5xx) - critical
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: server_errors
              matchType: '='
          repeatInterval: 15m
          groupInterval: 2m
          groupWait: 0s
          muteTimeIntervals: []

        # Latency anomalies - critical
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: latency_anomaly
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 5m
          groupWait: 10s
          muteTimeIntervals: []

        # Latency anomalies - warning
        - receiver: observatory-pool-warning
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: latency_anomaly
              matchType: '='
          repeatInterval: 1h
          groupInterval: 10m
          groupWait: 30s
          muteTimeIntervals: []

        # Latency spikes (P99 > 5s)
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - category
          matchers:
            - name: category
              value: latency_spike
              matchType: '='
          repeatInterval: 15m
          groupInterval: 3m
          groupWait: 0s
          muteTimeIntervals: []

        # Availability drops - critical
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - category
            - provider
          matchers:
            - name: category
              value: availability_drop
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 2m
          groupWait: 0s
          muteTimeIntervals: []

        # Availability drops - warning
        - receiver: observatory-pool-warning
          groupByStr:
            - alertname
            - category
            - provider
          matchers:
            - name: category
              value: availability_drop
              matchType: '='
          repeatInterval: 30m
          groupInterval: 5m
          groupWait: 30s
          muteTimeIntervals: []

        # Circuit breaker alerts
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
            - provider
          matchers:
            - name: category
              value: circuit_breaker
              matchType: '='
          repeatInterval: 15m
          groupInterval: 2m
          groupWait: 0s
          muteTimeIntervals: []

        # Multiple provider degradation
        - receiver: observatory-pool-critical
          groupByStr:
            - alertname
          matchers:
            - name: category
              value: multi_provider_degradation
              matchType: '='
          repeatInterval: 15m
          groupInterval: 5m
          groupWait: 0s
          muteTimeIntervals: []

        # ================================================================
        # EXISTING ALERT ROUTES
        # ================================================================

        # SLO alerts: route availability burn-rate (critical) to on-call.
        - receiver: critical-email
          groupByStr:
            - alertname
            - slo
          matchers:
            - name: component
              value: slo
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 5m
          groupWait: 0s
          muteTimeIntervals: []

        - receiver: ops-email
          groupByStr:
            - alertname
            - slo
          matchers:
            - name: component
              value: slo
              matchType: '='
          repeatInterval: 1h
          groupInterval: 10m
          groupWait: 5m
          muteTimeIntervals: []

        # Critical alerts - immediate delivery
        - receiver: critical-email
          groupByStr:
            - alertname
            - instance
          matchers:
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 5m
          groupWait: 0s
          muteTimeIntervals: []

        # Model alerts - group for 5 minutes
        - receiver: ops-email
          groupByStr:
            - alertname
            - model_id
          matchers:
            - name: category
              value: model
              matchType: '='
          repeatInterval: 30m
          groupInterval: 5m
          groupWait: 5m
          muteTimeIntervals: []

        # Redis alerts - high priority cache issues
        - receiver: critical-email
          groupByStr:
            - alertname
            - component
          matchers:
            - name: component
              value: redis
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 2m
          groupWait: 0s
          muteTimeIntervals: []

        - receiver: ops-email
          groupByStr:
            - alertname
            - component
          matchers:
            - name: component
              value: redis
              matchType: '='
          repeatInterval: 30m
          groupInterval: 5m
          groupWait: 2m
          muteTimeIntervals: []

        # Backend alerts - group for 5 minutes
        - receiver: ops-email
          groupByStr:
            - alertname
            - component
          matchers:
            - name: category
              value: backend
              matchType: '='
          repeatInterval: 30m
          groupInterval: 5m
          groupWait: 5m
          muteTimeIntervals: []

        # Infrastructure alerts - Prometheus targets
        - receiver: critical-email
          groupByStr:
            - alertname
            - job
          matchers:
            - name: component
              value: infrastructure
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 2m
          groupWait: 0s
          muteTimeIntervals: []

        # General alerts - group for 10 minutes
        - receiver: ops-email
          groupByStr:
            - alertname
          matchers:
            - name: category
              value: general
              matchType: '='
          repeatInterval: 1h
          groupInterval: 10m
          groupWait: 10m
          muteTimeIntervals: []

        # Logs alerts - immediate for critical, 5min for others
        - receiver: ops-email
          groupByStr:
            - alertname
            - service
          matchers:
            - name: category
              value: logs
              matchType: '='
            - name: severity
              value: critical
              matchType: '='
          repeatInterval: 15m
          groupInterval: 5m
          groupWait: 0s
          muteTimeIntervals: []

        - receiver: ops-email
          groupByStr:
            - alertname
            - service
          matchers:
            - name: category
              value: logs
              matchType: '='
          repeatInterval: 30m
          groupInterval: 5m
          groupWait: 5m
          muteTimeIntervals: []

      # Default handling - group info alerts for 30 minutes
      repeatInterval: 1h
      groupInterval: 30m
      groupWait: 30m
