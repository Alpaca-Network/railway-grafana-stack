apiVersion: 1

groups:
  - orgId: 1
    name: availability_anomalies
    folder: Abnormal Behavior
    interval: 1m
    rules:
      # ================================================================
      # PROVIDER AVAILABILITY - CRITICAL (<90%)
      # ================================================================
      - uid: provider_availability_critical
        title: Provider Availability Critical - Below 90%
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'CRITICAL: Provider availability is below 90%. Check provider status page, enable fallback routing to alternate providers, review circuit breaker status, notify affected users if necessary.'
          summary: 'Provider availability critically low'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/provider-outage'
        labels:
          severity: critical
          category: availability_drop
          component: provider
        data:
          - refId: A
            queryType: ''
            model:
              expr: '(100 * avg(provider_availability) by (provider)) < 90'
              hide: false
              intervalFactor: 1
              legendFormat: '{{ provider }}'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # PROVIDER AVAILABILITY - WARNING (<95%)
      # ================================================================
      - uid: provider_availability_warning
        title: Provider Availability Warning - Below 95%
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: 'Warning: Provider availability is below 95%. Monitor provider closely, review error patterns, prepare fallback if degradation continues.'
          summary: 'Provider availability below threshold'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/provider-degradation'
        labels:
          severity: warning
          category: availability_drop
          component: provider
        data:
          - refId: A
            queryType: ''
            model:
              expr: '((100 * avg(provider_availability) by (provider)) < 95) and ((100 * avg(provider_availability) by (provider)) >= 90)'
              hide: false
              intervalFactor: 1
              legendFormat: '{{ provider }}'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # SYSTEM AVAILABILITY - CRITICAL (<95%)
      # ================================================================
      - uid: system_availability_critical
        title: System Availability Critical - Below 95%
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'CRITICAL: System availability is below 95%. This indicates major service degradation. Check all production instances are running, verify load balancer health, review recent deployments, check database and cache connectivity.'
          summary: 'System availability below 95%'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/system-outage'
        labels:
          severity: critical
          category: availability_drop
          component: system
        data:
          - refId: A
            queryType: ''
            model:
              expr: '(100 * (sum(up{job="gatewayz_production"}) / count(up{job="gatewayz_production"}))) < 95'
              hide: false
              intervalFactor: 1
              legendFormat: 'System Availability'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # CIRCUIT BREAKER OPEN - CRITICAL
      # ================================================================
      - uid: circuit_breaker_open_abnormal
        title: Circuit Breaker Open - Provider Blocked
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          description: 'Circuit breaker is OPEN. This means the provider has been automatically blocked due to failures. Requests are being routed to fallback providers. Check provider error logs, wait for half-open state to test recovery, consider manual intervention if issue persists.'
          summary: 'Circuit breaker protecting against failing provider'
        labels:
          severity: critical
          category: circuit_breaker
          component: provider
        data:
          - refId: A
            queryType: ''
            model:
              expr: 'circuit_breaker_state{state="open"} > 0'
              hide: false
              intervalFactor: 1
              legendFormat: '{{ provider }}'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # BACKEND DOWN - CRITICAL
      # ================================================================
      - uid: backend_down_critical
        title: Backend Instance Down
        condition: C
        noDataState: Alerting
        execErrState: Alerting
        for: 2m
        annotations:
          description: 'CRITICAL: GatewayZ backend instance is down! Check Railway deployment status, review application logs for crash, verify environment variables, check memory/CPU limits.'
          summary: 'Backend instance not responding'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/backend-down'
        labels:
          severity: critical
          category: availability_drop
          component: backend
        data:
          - refId: A
            queryType: ''
            model:
              expr: 'up{job="gatewayz_production"} == 0'
              hide: false
              intervalFactor: 1
              legendFormat: 'Backend Status'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # MULTIPLE PROVIDERS DEGRADED - CRITICAL
      # ================================================================
      - uid: multiple_providers_degraded
        title: Multiple Providers Degraded - Service Impact
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'CRITICAL: 3+ providers are degraded (availability < 95%). This indicates widespread issues. Check for common dependencies (network, DNS), review rate limiting across providers, verify API keys are valid, consider temporary traffic reduction.'
          summary: '3+ providers showing degraded availability'
        labels:
          severity: critical
          category: multi_provider_degradation
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: 'count(100 * avg(provider_availability) by (provider) < 95) >= 3'
              hide: false
              intervalFactor: 1
              legendFormat: 'Degraded Provider Count'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

    provenance: Grafana
