apiVersion: 1

groups:
  - orgId: 1
    name: latency_anomalies
    folder: Abnormal Behavior
    interval: 1m
    rules:
      # ================================================================
      # LATENCY DEGRADATION - CRITICAL (2x Baseline)
      # ================================================================
      - uid: latency_degradation_critical
        title: Latency Degradation Critical - 2x Baseline
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: |
            CRITICAL: P95 latency is {{ printf "%.2f" $values.A.Value }}s
            Baseline (1h avg): {{ printf "%.2f" $values.B.Value }}s
            This is {{ printf "%.1f" (div $values.A.Value $values.B.Value) }}x normal latency.

            **Immediate Actions:**
            1. Check provider health and response times
            2. Review recent deployments or configuration changes
            3. Monitor downstream dependencies
            4. Check for resource exhaustion (CPU, memory)
          summary: 'P95 latency is 2x+ baseline - performance degraded'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/latency-investigation'
        labels:
          severity: critical
          category: latency_anomaly
          component: gateway
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: grafana_mimir
            model:
              expr: 'latency:p95:seconds'
              refId: A
          - refId: B
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: grafana_mimir
            model:
              expr: 'latency:p95:seconds:1h_avg'
              refId: B
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: '($A / $B > 2) && ($A > 1.0)'
              refId: C

      # ================================================================
      # LATENCY DEGRADATION - WARNING (1.5x Baseline)
      # ================================================================
      - uid: latency_degradation_warning
        title: Latency Degradation Warning - 1.5x Baseline
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: |
            Warning: P95 latency is {{ printf "%.2f" $values.A.Value }}s
            Baseline (1h avg): {{ printf "%.2f" $values.B.Value }}s
            This is {{ printf "%.1f" (div $values.A.Value $values.B.Value) }}x normal latency.

            **Recommended Actions:**
            1. Monitor the situation closely
            2. Check if this correlates with traffic changes
            3. Review provider performance metrics
          summary: 'P95 latency is 1.5x+ baseline - monitoring required'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/latency-investigation'
        labels:
          severity: warning
          category: latency_anomaly
          component: gateway
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: grafana_mimir
            model:
              expr: 'latency:p95:seconds'
              refId: A
          - refId: B
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: grafana_mimir
            model:
              expr: 'latency:p95:seconds:1h_avg'
              refId: B
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: '($A / $B > 1.5) && ($A / $B <= 2) && ($A > 0.5)'
              refId: C

      # ================================================================
      # P99 LATENCY SPIKE - CRITICAL (>5s)
      # ================================================================
      - uid: p99_latency_critical
        title: P99 Latency Critical - Above 5 Seconds
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: |
            CRITICAL: P99 latency is {{ printf "%.2f" $values.A.Value }}s

            **This affects the worst 1% of requests:**
            1. Likely timeout risk for clients
            2. Check for slow provider responses
            3. Look for resource contention
            4. Review request queue depth
          summary: 'P99 latency exceeds 5s threshold'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/latency-investigation'
        labels:
          severity: critical
          category: latency_spike
          component: gateway
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: grafana_mimir
            model:
              expr: 'latency:p99:seconds'
              refId: A
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: '$A > 5'
              refId: C

      # ================================================================
      # TIME TO FIRST CHUNK (TTFC) - STREAMING LATENCY
      # ================================================================
      - uid: ttfc_degradation_warning
        title: Time to First Chunk Degradation - Streaming Slow
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: |
            Warning: Time to First Chunk (TTFC) P95 is {{ printf "%.2f" $values.A.Value }}s

            **This affects perceived streaming performance:**
            1. Users experience delay before seeing response
            2. Check AI provider cold start times
            3. Review model loading latencies
          summary: 'TTFC P95 exceeds 3s - streaming feels slow'
        labels:
          severity: warning
          category: latency_anomaly
          component: streaming
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: grafana_mimir
            model:
              expr: 'histogram_quantile(0.95, rate(time_to_first_chunk_seconds_bucket[5m]))'
              refId: A
          - refId: C
            queryType: ''
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: '$A > 3'
              refId: C

    provenance: Grafana
