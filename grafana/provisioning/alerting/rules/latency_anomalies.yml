apiVersion: 1

groups:
  - orgId: 1
    name: latency_anomalies
    folder: Abnormal Behavior
    interval: 1m
    rules:
      # ================================================================
      # LATENCY DEGRADATION - CRITICAL (P95 > 5s)
      # ================================================================
      - uid: latency_degradation_critical
        title: Latency Degradation Critical - P95 Above 5s
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: 'CRITICAL: P95 latency exceeds 5 seconds. Check provider health and response times, review recent deployments or configuration changes, monitor downstream dependencies, check for resource exhaustion (CPU, memory).'
          summary: 'P95 latency exceeds 5s - performance degraded'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/latency-investigation'
        labels:
          severity: critical
          category: latency_anomaly
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: 'histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 5'
              hide: false
              intervalFactor: 1
              legendFormat: 'P95 Latency'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # LATENCY DEGRADATION - WARNING (P95 > 2s)
      # ================================================================
      - uid: latency_degradation_warning
        title: Latency Degradation Warning - P95 Above 2s
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: 'Warning: P95 latency exceeds 2 seconds. Monitor the situation closely, check if this correlates with traffic changes, review provider performance metrics.'
          summary: 'P95 latency elevated - monitoring required'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/latency-investigation'
        labels:
          severity: warning
          category: latency_anomaly
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: '(histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2) and (histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) <= 5)'
              hide: false
              intervalFactor: 1
              legendFormat: 'P95 Latency'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # P99 LATENCY SPIKE - CRITICAL (>10s)
      # ================================================================
      - uid: p99_latency_critical
        title: P99 Latency Critical - Above 10 Seconds
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'CRITICAL: P99 latency exceeds 10 seconds. This affects the worst 1% of requests. Likely timeout risk for clients. Check for slow provider responses, look for resource contention, review request queue depth.'
          summary: 'P99 latency exceeds 10s threshold'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/latency-investigation'
        labels:
          severity: critical
          category: latency_spike
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: 'histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 10'
              hide: false
              intervalFactor: 1
              legendFormat: 'P99 Latency'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # TIME TO FIRST CHUNK (TTFC) - STREAMING LATENCY
      # ================================================================
      - uid: ttfc_degradation_warning
        title: Time to First Chunk Degradation - Streaming Slow
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: 'Warning: Time to First Chunk (TTFC) P95 exceeds 3 seconds. This affects perceived streaming performance. Users experience delay before seeing response. Check AI provider cold start times, review model loading latencies.'
          summary: 'TTFC P95 exceeds 3s - streaming feels slow'
        labels:
          severity: warning
          category: latency_anomaly
          component: streaming
        data:
          - refId: A
            queryType: ''
            model:
              expr: 'histogram_quantile(0.95, sum(rate(time_to_first_chunk_seconds_bucket[5m])) by (le)) > 3'
              hide: false
              intervalFactor: 1
              legendFormat: 'TTFC P95'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

    provenance: Grafana
