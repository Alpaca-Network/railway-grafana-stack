apiVersion: 1

groups:
  - orgId: 1
    name: error_rate_anomalies
    folder: Abnormal Behavior
    interval: 1m
    rules:
      # ================================================================
      # ERROR RATE SPIKE - CRITICAL (>10%)
      # ================================================================
      - uid: error_rate_critical
        title: Error Rate Critical - Above 10%
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'CRITICAL: Error rate exceeds 10%. Check application logs for stack traces, verify database connectivity, check external API dependencies, and review recent deployments.'
          summary: 'Error rate exceeds 10% - immediate investigation required'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/error-investigation'
        labels:
          severity: critical
          category: error_rate_spike
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: '(sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 10'
              hide: false
              intervalFactor: 1
              legendFormat: 'Error Rate %'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # ERROR RATE SPIKE - WARNING (>5%)
      # ================================================================
      - uid: error_rate_warning
        title: Error Rate Warning - Above 5%
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Warning: Error rate exceeds 5%. Monitor closely and investigate if rate continues to climb.'
          summary: 'Error rate elevated above 5%'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/error-investigation'
        labels:
          severity: warning
          category: error_rate_spike
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: '((sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5) and ((sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 <= 10)'
              hide: false
              intervalFactor: 1
              legendFormat: 'Error Rate %'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

      # ================================================================
      # 5XX SERVER ERRORS - CRITICAL
      # ================================================================
      - uid: server_error_5xx_critical
        title: 5xx Server Errors Critical - Above 5%
        condition: C
        noDataState: NoData
        execErrState: Alerting
        for: 3m
        annotations:
          description: 'CRITICAL: 5xx server error rate exceeds 5%. Server errors indicate internal problems: application crashes, database connection failures, dependency service failures, or resource exhaustion.'
          summary: '5xx server error rate exceeds 5%'
          runbook_url: 'https://wiki.gatewayz.ai/runbooks/server-errors'
        labels:
          severity: critical
          category: server_errors
          component: gateway
        data:
          - refId: A
            queryType: ''
            model:
              expr: '(sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5'
              hide: false
              intervalFactor: 1
              legendFormat: '5xx Error Rate %'
              refId: A
          - refId: C
            queryType: ''
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  type: query
              type: threshold

    provenance: Grafana
