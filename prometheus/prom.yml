global:
  scrape_interval: 15s # Default scrape interval
  external_labels:
    cluster: gatewayz-monitoring
    environment: ${ENVIRONMENT:-production}

# Remote write to Mimir for long-term storage and consistent queries
# This ensures metrics are not lost on Prometheus restart and provides
# consistent data across page refreshes
remote_write:
  - url: http://mimir:9009/api/v1/push
    name: mimir-remote-write
    remote_timeout: 30s
    queue_config:
      capacity: 10000
      max_shards: 50
      max_samples_per_send: 2000
      batch_send_deadline: 5s
      min_backoff: 30ms
      max_backoff: 5s

rule_files:
  - '/etc/prometheus/alert.rules.yml'

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # MERGED: Combined gatewayz_api and fastapi_backend (were duplicates)
  # Production GatewayZ Backend API
  - job_name: 'gatewayz_production'
    scheme: http
    metrics_path: '/metrics'
    static_configs:
      - targets: ['FASTAPI_TARGET']
    scrape_interval: 15s
    scrape_timeout: 10s
    bearer_token_file: '/etc/prometheus/secrets/production_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: production

  # Local Redis Exporter (Docker Compose)
  - job_name: 'redis_exporter'
    scheme: http
    static_configs:
      - targets: ['redis-exporter:9121']
    scrape_interval: 30s  # Increased from 15s - Redis metrics change slowly
    scrape_timeout: 10s

  # Production Redis on Railway (if exposing metrics endpoint)
  # NOTE: This endpoint may not exist - Redis doesn't expose /metrics by default
  # COMMENTED OUT until verified
  # - job_name: 'redis_gateway_production'
  #   scheme: https
  #   metrics_path: '/metrics'
  #   static_configs:
  #     - targets: ['redis-production-bb6d.up.railway.app']
  #   scrape_interval: 30s
  #   scrape_timeout: 10s

  # Staging GatewayZ Backend API
  # SECURITY: Bearer token is loaded from file to avoid hardcoding in config
  - job_name: 'gatewayz_staging'
    scheme: https
    metrics_path: '/metrics'
    static_configs:
      - targets: ['gatewayz-staging.up.railway.app']
    scrape_interval: 15s
    scrape_timeout: 10s
    bearer_token_file: '/etc/prometheus/secrets/staging_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: staging

  # Health Service Metrics Exporter
  - job_name: 'health_service_exporter'
    scheme: http
    static_configs:
      - targets: ['health-service-exporter:8002']
    scrape_interval: 30s
    scrape_timeout: 10s

  # GatewayZ Prometheus Data Metrics (Provider health, circuit breakers, etc.)
  # This scrapes /prometheus/data/metrics for Grafana alerting
  - job_name: 'gatewayz_data_metrics_production'
    scheme: http
    metrics_path: '/prometheus/data/metrics'
    static_configs:
      - targets: ['FASTAPI_TARGET']
    scrape_interval: 30s
    scrape_timeout: 15s
    bearer_token_file: '/etc/prometheus/secrets/production_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: production
      - source_labels: []
        target_label: source
        replacement: prometheus_data

  # Staging environment data metrics
  # SECURITY: Bearer token is loaded from file to avoid hardcoding in config
  - job_name: 'gatewayz_data_metrics_staging'
    scheme: https
    metrics_path: '/prometheus/data/metrics'
    static_configs:
      - targets: ['gatewayz-staging.up.railway.app']
    scrape_interval: 30s
    scrape_timeout: 15s
    bearer_token_file: '/etc/prometheus/secrets/staging_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: staging
      - source_labels: []
        target_label: source
        replacement: prometheus_data

  # Mimir - Long-term metrics storage (monitors itself)
  - job_name: 'mimir'
    scheme: http
    static_configs:
      - targets: ['mimir:9009']
    scrape_interval: 30s
    scrape_timeout: 10s
    metric_relabel_configs:
      - source_labels: []
        target_label: component
        replacement: mimir
