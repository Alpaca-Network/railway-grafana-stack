groups:
  - name: performance_alerts
    interval: 30s
    rules:
      # API Request Rate Alerts
      - alert: LowAPIRequestRate
        expr: sum(rate(fastapi_requests_total[5m])) < 10
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "Low API request rate detected"
          description: "API request rate is {{ $value }} req/s, below expected threshold of 10 req/s. This may indicate service issues."

      - alert: HighAPIErrorRate
        expr: sum(rate(fastapi_requests_total{status_code=~'4..|5..'}[5m])) / sum(rate(fastapi_requests_total[5m])) > 0.1
        for: 3m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High API error rate detected"
          description: "API error rate is {{ $value | humanizePercentage }}, exceeding critical threshold of 10%. Immediate investigation required."

      # API Latency Alerts
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(fastapi_requests_duration_seconds_bucket[5m])) by (le)) > 2.0
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "High API latency detected"
          description: "API latency (p95) is {{ $value }}s, exceeding threshold of 2.0s. This indicates slow API response times."

      - alert: CriticalAPILatency
        expr: histogram_quantile(0.95, sum(rate(fastapi_requests_duration_seconds_bucket[5m])) by (le)) > 3.0
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "Critical API latency detected"
          description: "API latency (p95) is {{ $value }}s, exceeding critical threshold of 3.0s. Immediate investigation required."

      # Model Inference Alerts
      - alert: HighModelInferenceLatency
        expr: histogram_quantile(0.95, sum(rate(model_inference_duration_seconds_bucket[5m])) by (le, model)) > 5.0
        for: 5m
        labels:
          severity: warning
          component: model
        annotations:
          summary: "High model inference latency for {{ $labels.model }}"
          description: "Model {{ $labels.model }} inference latency (p95) is {{ $value }}s, exceeding threshold of 5.0s."

      - alert: ModelInferenceErrorSpike
        expr: sum(rate(model_inference_requests_total{status="error"}[5m])) / sum(rate(model_inference_requests_total[5m])) > 0.15
        for: 3m
        labels:
          severity: critical
          component: model
        annotations:
          summary: "High model inference error rate"
          description: "Model inference error rate is {{ $value | humanizePercentage }}, exceeding critical threshold of 15%."

      # Provider-Specific Alerts
      - alert: SlowProviderResponse
        expr: histogram_quantile(0.95, sum(rate(model_inference_duration_seconds_bucket{provider!=""}[5m])) by (le, provider)) > 4.0
        for: 5m
        labels:
          severity: warning
          component: provider
        annotations:
          summary: "Slow response from provider {{ $labels.provider }}"
          description: "Provider {{ $labels.provider }} response latency (p95) is {{ $value }}s, exceeding threshold of 4.0s."

      - alert: ProviderErrorSpike
        expr: sum(rate(model_inference_requests_total{status="error", provider!=""}[5m])) by (provider) / sum(rate(model_inference_requests_total{provider!=""}[5m])) by (provider) > 0.2
        for: 3m
        labels:
          severity: critical
          component: provider
        annotations:
          summary: "High error rate for provider {{ $labels.provider }}"
          description: "Provider {{ $labels.provider }} error rate is {{ $value | humanizePercentage }}, exceeding critical threshold of 20%."

  - name: performance_trends
    interval: 1m
    rules:
      # Trend Detection - API Latency Degradation
      - alert: APILatencyDegrading
        expr: |
          (
            histogram_quantile(0.95, sum(rate(fastapi_requests_duration_seconds_bucket[15m])) by (le)) /
            histogram_quantile(0.95, sum(rate(fastapi_requests_duration_seconds_bucket[15m] offset 1h)) by (le))
          ) > 1.5
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API latency degrading over time"
          description: "API latency (p95) has increased by more than 50% compared to 1 hour ago. Current: {{ $value }}x baseline."

      # Trend Detection - API Error Rate Increase
      - alert: APIErrorRateIncreasing
        expr: |
          (
            sum(rate(fastapi_requests_total{status_code=~'4..|5..'}[15m])) / sum(rate(fastapi_requests_total[15m]))
          ) /
          (
            sum(rate(fastapi_requests_total{status_code=~'4..|5..'}[15m] offset 1h)) / sum(rate(fastapi_requests_total[15m] offset 1h))
          ) > 2.0
        for: 10m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "API error rate increasing over time"
          description: "API error rate has increased by more than 100% compared to 1 hour ago. Current: {{ $value }}x baseline."
