global:
  scrape_interval: 15s # Default scrape interval
  external_labels:
    cluster: gatewayz-monitoring
    environment: ${ENVIRONMENT:-production}

# Alerting configuration
# Alerts are evaluated by Prometheus and sent to Alertmanager
# Alertmanager handles routing, grouping, and notification delivery
# NOTE: ALERTMANAGER_TARGET is substituted by entrypoint.sh at runtime
# - Railway: Uses alertmanager.railway.internal:9093
# - Local: Uses alertmanager:9093 (Docker Compose network)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'ALERTMANAGER_TARGET'
      timeout: 10s
      api_version: v2

# Remote write to Mimir for long-term storage and consistent queries
# This ensures metrics are not lost on Prometheus restart and provides
# consistent data across page refreshes
# NOTE: MIMIR_URL is substituted by entrypoint.sh at runtime
# - Railway: Uses mimir.railway.internal:9009
# - Local: Uses mimir:9009 (Docker Compose network)
remote_write:
  - url: MIMIR_URL/api/v1/push
    name: mimir-remote-write
    remote_timeout: 30s
    queue_config:
      capacity: 10000
      max_shards: 50
      max_samples_per_send: 2000
      batch_send_deadline: 5s
      min_backoff: 30ms
      max_backoff: 5s

rule_files:
  - '/etc/prometheus/alert.rules.yml'
  - '/etc/prometheus/recording_rules_baselines.yml'

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # MERGED: Combined gatewayz_api and fastapi_backend (were duplicates)
  # Production GatewayZ Backend API
  # NOTE: FASTAPI_TARGET and FASTAPI_SCHEME are substituted by entrypoint.sh
  - job_name: 'gatewayz_production'
    scheme: FASTAPI_SCHEME
    metrics_path: '/metrics'
    static_configs:
      - targets: ['FASTAPI_TARGET']
    scrape_interval: 15s
    scrape_timeout: 10s
    bearer_token_file: '/etc/prometheus/secrets/production_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: production

  # Redis Exporter - scrapes Redis metrics from backend project
  # NOTE: REDIS_EXPORTER_TARGET is substituted by entrypoint.sh at runtime
  # Since Redis Exporter is in a different Railway project (backend),
  # we use the public URL, not internal networking
  # Set REDIS_EXPORTER_URL environment variable in Railway to the public URL
  - job_name: 'redis_exporter'
    scheme: https
    static_configs:
      - targets: ['REDIS_EXPORTER_TARGET']
    scrape_interval: 30s
    scrape_timeout: 10s
    metric_relabel_configs:
      - source_labels: []
        target_label: component
        replacement: redis

  # Staging GatewayZ Backend API
  # SECURITY: Bearer token is loaded from file to avoid hardcoding in config
  - job_name: 'gatewayz_staging'
    scheme: https
    metrics_path: '/metrics'
    static_configs:
      - targets: ['gatewayz-staging.up.railway.app']
    scrape_interval: 15s
    scrape_timeout: 10s
    bearer_token_file: '/etc/prometheus/secrets/staging_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: staging

  # Health Service Metrics Exporter
  - job_name: 'health_service_exporter'
    scheme: http
    static_configs:
      - targets: ['health-service-exporter:8002']
    scrape_interval: 30s
    scrape_timeout: 10s

  # GatewayZ Prometheus Data Metrics (Provider health, circuit breakers, etc.)
  # This scrapes /prometheus/data/metrics for Grafana alerting
  # NOTE: FASTAPI_TARGET and FASTAPI_SCHEME are substituted by entrypoint.sh
  - job_name: 'gatewayz_data_metrics_production'
    scheme: FASTAPI_SCHEME
    metrics_path: '/prometheus/data/metrics'
    static_configs:
      - targets: ['FASTAPI_TARGET']
    scrape_interval: 30s
    scrape_timeout: 15s
    bearer_token_file: '/etc/prometheus/secrets/production_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: production
      - source_labels: []
        target_label: source
        replacement: prometheus_data

  # Staging environment data metrics
  # SECURITY: Bearer token is loaded from file to avoid hardcoding in config
  - job_name: 'gatewayz_data_metrics_staging'
    scheme: https
    metrics_path: '/prometheus/data/metrics'
    static_configs:
      - targets: ['gatewayz-staging.up.railway.app']
    scrape_interval: 30s
    scrape_timeout: 15s
    bearer_token_file: '/etc/prometheus/secrets/staging_bearer_token'
    metric_relabel_configs:
      - source_labels: []
        target_label: env
        replacement: staging
      - source_labels: []
        target_label: source
        replacement: prometheus_data

  # Mimir - Long-term metrics storage (monitors itself)
  # NOTE: MIMIR_TARGET is substituted by entrypoint.sh at runtime
  # - Railway: Uses mimir.railway.internal:9009
  # - Local: Uses mimir:9009 (Docker Compose network)
  - job_name: 'mimir'
    scheme: http
    static_configs:
      - targets: ['MIMIR_TARGET']
    scrape_interval: 30s
    scrape_timeout: 10s
    metric_relabel_configs:
      - source_labels: []
        target_label: component
        replacement: mimir
