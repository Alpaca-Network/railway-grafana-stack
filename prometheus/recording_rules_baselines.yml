# ============================================================
# PROMETHEUS RECORDING RULES - BASELINE CALCULATIONS
# ============================================================
# These rules pre-calculate baseline metrics for anomaly detection
# They run continuously to establish "normal" behavior patterns
# Updated to use fastapi_requests_total (new metric) instead of http_requests_total

groups:
  # ============================================================
  # TRAFFIC BASELINES
  # ============================================================
  - name: traffic_baselines
    interval: 1m
    rules:
      # Current request rate per second
      - record: traffic:requests_per_second:rate5m
        expr: sum(rate(fastapi_requests_total[5m]))

      # 1-hour average request rate
      - record: traffic:requests_per_second:rate1h
        expr: avg_over_time(sum(rate(fastapi_requests_total[5m]))[1h:])

      # 24-hour average request rate (daily baseline)
      - record: traffic:requests_per_second:rate24h
        expr: avg_over_time(sum(rate(fastapi_requests_total[5m]))[24h:])

      # 7-day average request rate (weekly baseline)
      - record: traffic:requests_per_second:rate7d
        expr: avg_over_time(sum(rate(fastapi_requests_total[5m]))[7d:])

      # Request rate by endpoint
      - record: traffic:requests_per_second:by_endpoint
        expr: sum by (path) (rate(fastapi_requests_total[5m]))

  # ============================================================
  # ERROR RATE BASELINES
  # ============================================================
  - name: error_rate_baselines
    interval: 1m
    rules:
      # Current error rate percentage (4xx + 5xx)
      - record: errors:rate:percentage
        expr: |
          100 * (
            sum(rate(fastapi_requests_total{status_code=~"4..|5.."}[5m]))
            /
            sum(rate(fastapi_requests_total[5m]))
          ) or vector(0)

      # 4xx client error rate
      - record: errors:4xx:percentage
        expr: |
          100 * (
            sum(rate(fastapi_requests_total{status_code=~"4.."}[5m]))
            /
            sum(rate(fastapi_requests_total[5m]))
          ) or vector(0)

      # 5xx server error rate
      - record: errors:5xx:percentage
        expr: |
          100 * (
            sum(rate(fastapi_requests_total{status_code=~"5.."}[5m]))
            /
            sum(rate(fastapi_requests_total[5m]))
          ) or vector(0)

      # 1-hour error rate average
      - record: errors:rate:percentage:1h_avg
        expr: avg_over_time(errors:rate:percentage[1h])

      # 24-hour error rate average (daily baseline)
      - record: errors:rate:percentage:24h_avg
        expr: avg_over_time(errors:rate:percentage[24h])

      # Error rate by endpoint
      - record: errors:rate:by_endpoint
        expr: |
          100 * (
            sum by (path) (rate(fastapi_requests_total{status_code=~"4..|5.."}[5m]))
            /
            sum by (path) (rate(fastapi_requests_total[5m]))
          ) or vector(0)

  # ============================================================
  # LATENCY BASELINES
  # ============================================================
  - name: latency_baselines
    interval: 1m
    rules:
      # P50 (median) latency
      - record: latency:p50:seconds
        expr: histogram_quantile(0.50, sum(rate(fastapi_requests_duration_seconds_bucket[5m])) by (le))

      # P95 latency
      - record: latency:p95:seconds
        expr: histogram_quantile(0.95, sum(rate(fastapi_requests_duration_seconds_bucket[5m])) by (le))

      # P99 latency
      - record: latency:p99:seconds
        expr: histogram_quantile(0.99, sum(rate(fastapi_requests_duration_seconds_bucket[5m])) by (le))

      # 1-hour P95 average
      - record: latency:p95:seconds:1h_avg
        expr: avg_over_time(latency:p95:seconds[1h])

      # 24-hour P95 average (daily baseline)
      - record: latency:p95:seconds:24h_avg
        expr: avg_over_time(latency:p95:seconds[24h])

      # 1-hour P99 average
      - record: latency:p99:seconds:1h_avg
        expr: avg_over_time(latency:p99:seconds[1h])

      # Latency by endpoint
      - record: latency:p95:by_endpoint
        expr: histogram_quantile(0.95, sum by (path, le) (rate(fastapi_requests_duration_seconds_bucket[5m])))

  # ============================================================
  # MODEL USAGE BASELINES (for Analytics Dashboard)
  # ============================================================
  - name: model_usage_baselines
    interval: 1m
    rules:
      # Total model inference requests rate
      - record: models:requests:rate5m
        expr: sum(rate(model_inference_requests_total[5m]))

      # Model requests by provider
      - record: models:requests:by_provider:rate5m
        expr: sum by (provider) (rate(model_inference_requests_total[5m]))

      # Model requests by model name
      - record: models:requests:by_model:rate5m
        expr: sum by (model) (rate(model_inference_requests_total[5m]))

      # Top models by request count (1h)
      - record: models:requests:by_model:1h_total
        expr: sum by (model) (increase(model_inference_requests_total[1h]))

      # Top models by request count (24h)
      - record: models:requests:by_model:24h_total
        expr: sum by (model) (increase(model_inference_requests_total[24h]))

      # Token usage by model
      - record: models:tokens:by_model:rate5m
        expr: sum by (model) (rate(tokens_used_total[5m]))

      # Token usage by provider
      - record: models:tokens:by_provider:rate5m
        expr: sum by (provider) (rate(tokens_used_total[5m]))

  # ============================================================
  # AVAILABILITY BASELINES
  # ============================================================
  - name: availability_baselines
    interval: 1m
    rules:
      # Provider availability percentage
      - record: availability:provider:percentage
        expr: avg by (provider) (provider_availability) * 100

      # Overall system availability
      - record: availability:system:percentage
        expr: |
          100 * (
            sum(up{job="gatewayz_production"})
            /
            count(up{job="gatewayz_production"})
          ) or vector(100)

  # ============================================================
  # COST BASELINES
  # ============================================================
  - name: cost_baselines
    interval: 5m
    rules:
      # Hourly cost total
      - record: cost:hourly:total
        expr: sum(increase(gatewayz_api_cost_usd_total[1h]))

      # Daily cost sum
      - record: cost:daily:total
        expr: sum(increase(gatewayz_api_cost_usd_total[24h]))

      # Cost by provider
      - record: cost:by_provider:rate5m
        expr: sum by (provider) (rate(gatewayz_api_cost_usd_total[5m]))

      # Cost by model
      - record: cost:by_model:rate5m
        expr: sum by (model) (rate(gatewayz_api_cost_usd_total[5m]))

  # ============================================================
  # REDIS BASELINES (from redis_exporter)
  # ============================================================
  - name: redis_baselines
    interval: 1m
    rules:
      # Redis memory usage percentage
      - record: redis:memory:percentage
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) * 100 or vector(0)

      # Redis connected clients
      - record: redis:clients:connected
        expr: redis_connected_clients or vector(0)

      # Redis cache hit rate
      - record: redis:cache:hit_rate
        expr: |
          100 * (
            rate(redis_keyspace_hits_total[5m])
            /
            (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))
          ) or vector(0)
