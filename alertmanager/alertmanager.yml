# ============================================================================
# GatewayZ Alertmanager Configuration
# ============================================================================
#
# This file is processed by entrypoint.sh at container startup.
# Placeholders are substituted from environment variables:
#
#   SMTP_HOST          SMTP server host:port  (default: smtp.gmail.com:465)
#   SMTP_FROM          From address           (required)
#   SMTP_USER          SMTP username          (required)
#   SMTP_PASSWORD      SMTP password / app-password (required)
#   ALERT_EMAIL_OPS    Ops team email(s)      (default: manjeshprasad21@gmail.com,vaughn@alpacanetwork.ai)
#   ALERT_EMAIL_CRIT   Critical-pager email(s)(default: same as ops)
#   EXTERNAL_URL       Public URL of this Alertmanager service (for links in emails)
#
# NOTE: matchers use Alertmanager string syntax: 'label="value"'
# NOT the Grafana provisioning map syntax (name/value/matchType).
# ============================================================================

global:
  resolve_timeout: 5m

  # SMTP — all values substituted by entrypoint.sh
  smtp_smarthost:     'SMTP_HOST_PLACEHOLDER'
  smtp_from:          'SMTP_FROM_PLACEHOLDER'
  smtp_auth_username: 'SMTP_USER_PLACEHOLDER'
  smtp_auth_password: 'SMTP_PASSWORD_PLACEHOLDER'
  smtp_require_tls:   false

# ============================================================================
# Templates
# ============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ============================================================================
# Routing Tree
# ============================================================================
route:
  receiver: ops-email
  group_by: [alertname, instance]
  group_wait:      30s
  group_interval:  5m
  repeat_interval: 1h

  routes:
    # ------------------------------------------------------------------
    # CRITICAL severity — immediate, 15 min repeat
    # ------------------------------------------------------------------
    - receiver: critical-email
      matchers:
        - 'severity="critical"'
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m
      continue: false

    # ------------------------------------------------------------------
    # SLO burn-rate
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, slo]
      matchers:
        - 'component="slo"'
        - 'severity="critical"'
      group_wait:      0s
      group_interval:  5m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, slo]
      matchers:
        - 'component="slo"'
      group_wait:      5m
      group_interval:  10m
      repeat_interval: 1h

    # ------------------------------------------------------------------
    # Traffic spikes
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - 'category="traffic_spike"'
        - 'severity="critical"'
      group_wait:      10s
      group_interval:  5m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - 'category="traffic_spike"'
      group_wait:      30s
      group_interval:  10m
      repeat_interval: 1h

    # ------------------------------------------------------------------
    # Traffic drop
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - 'category="traffic_drop"'
      group_wait:      30s
      group_interval:  10m
      repeat_interval: 1h

    # ------------------------------------------------------------------
    # Error rate spike
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - 'category="error_rate_spike"'
        - 'severity="critical"'
      group_wait:      0s
      group_interval:  3m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - 'category="error_rate_spike"'
      group_wait:      30s
      group_interval:  5m
      repeat_interval: 30m

    # ------------------------------------------------------------------
    # Server errors (5xx)
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - 'category="server_errors"'
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Latency
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - 'category="latency_anomaly"'
        - 'severity="critical"'
      group_wait:      10s
      group_interval:  5m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - 'category="latency_anomaly"'
      group_wait:      30s
      group_interval:  10m
      repeat_interval: 1h

    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - 'category="latency_spike"'
      group_wait:      0s
      group_interval:  3m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Availability / circuit breaker
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category, provider]
      matchers:
        - 'category="availability_drop"'
        - 'severity="critical"'
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category, provider]
      matchers:
        - 'category="availability_drop"'
      group_wait:      30s
      group_interval:  5m
      repeat_interval: 30m

    - receiver: critical-email
      group_by: [alertname, provider]
      matchers:
        - 'category="circuit_breaker"'
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    - receiver: critical-email
      group_by: [alertname]
      matchers:
        - 'category="multi_provider_degradation"'
      group_wait:      0s
      group_interval:  5m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Model-level alerts
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, model_id]
      matchers:
        - 'category="model"'
      group_wait:      5m
      group_interval:  5m
      repeat_interval: 30m

    # ------------------------------------------------------------------
    # Backend / infrastructure
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, component]
      matchers:
        - 'category="backend"'
      group_wait:      5m
      group_interval:  5m
      repeat_interval: 30m

    - receiver: critical-email
      group_by: [alertname, job]
      matchers:
        - 'component="infrastructure"'
        - 'severity="critical"'
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Log-based alerts
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, service]
      matchers:
        - 'category="logs"'
      group_wait:      30s
      group_interval:  5m
      repeat_interval: 30m

# ============================================================================
# Receivers
# ============================================================================
receivers:
  - name: ops-email
    email_configs:
      - to: 'ALERT_EMAIL_OPS_PLACEHOLDER'
        send_resolved: true
        headers:
          Subject: '[GatewayZ] {{ .GroupLabels.alertname }} — {{ .Status | toUpper }}'
        html: |
          {{ range .Alerts }}
          <h2>{{ .Labels.alertname }}</h2>
          <p><strong>Status:</strong> {{ .Status }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Category:</strong> {{ .Labels.category }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Starts At:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
          {{ if .GeneratorURL }}<p><a href="{{ .GeneratorURL }}">View in Prometheus</a></p>{{ end }}
          <hr/>
          {{ end }}

  - name: critical-email
    email_configs:
      - to: 'ALERT_EMAIL_CRIT_PLACEHOLDER'
        send_resolved: true
        headers:
          Subject: '[GatewayZ CRITICAL] {{ .GroupLabels.alertname }} — {{ .Status | toUpper }}'
        html: |
          <h1 style="color:red">CRITICAL ALERT</h1>
          {{ range .Alerts }}
          <h2>{{ .Labels.alertname }}</h2>
          <p><strong>Status:</strong> {{ .Status }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Category:</strong> {{ .Labels.category }}</p>
          <p><strong>Provider:</strong> {{ .Labels.provider }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Runbook:</strong> {{ .Annotations.runbook_url }}</p>
          <p><strong>Starts At:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
          {{ if .GeneratorURL }}<p><a href="{{ .GeneratorURL }}">View in Prometheus</a></p>{{ end }}
          <hr/>
          {{ end }}

# ============================================================================
# Inhibition Rules
# ============================================================================
inhibit_rules:
  - source_matchers:
      - 'severity="critical"'
    target_matchers:
      - 'severity="warning"'
    equal: [alertname, instance]

  - source_matchers:
      - 'category="multi_provider_degradation"'
    target_matchers:
      - 'category="availability_drop"'
    equal: []
