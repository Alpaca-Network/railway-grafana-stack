# Alertmanager Configuration for GatewayZ
# Sends email notifications for critical alerts

global:
  # SMTP configuration for email alerts
  # Using Gmail SMTP (requires App Password if 2FA is enabled)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@gatewayz.ai'
  smtp_auth_username: '${SMTP_USERNAME}'  # Set in Railway environment
  smtp_auth_password: '${SMTP_PASSWORD}'  # Set in Railway environment (use App Password for Gmail)
  smtp_require_tls: true
  
  # Notification rate limiting
  resolve_timeout: 5m

# Route configuration - defines how alerts are routed to receivers
route:
  # Default receiver for all alerts
  receiver: 'email-default'
  
  # Group alerts by these labels to reduce notification spam
  group_by: ['alertname', 'severity', 'component']
  
  # Wait before sending notification (allows grouping)
  group_wait: 30s
  
  # Wait before sending notification about new alerts in group
  group_interval: 5m
  
  # Re-send notifications if alert is still firing
  repeat_interval: 4h
  
  # Child routes for specific alert types
  routes:
    # Critical alerts - send immediately
    - match:
        severity: critical
      receiver: 'email-critical'
      group_wait: 10s
      repeat_interval: 30m
      continue: true  # Also send to default receiver
    
    # Model health alerts - high priority
    - match:
        component: model
      receiver: 'email-model-health'
      group_wait: 1m
      repeat_interval: 1h
    
    # Provider health alerts
    - match:
        component: provider
      receiver: 'email-provider-health'
      group_wait: 2m
      repeat_interval: 2h

# Receivers - define where notifications are sent
receivers:
  # Default receiver for all alerts
  - name: 'email-default'
    email_configs:
      - to: 'manjeshprasad21@gmail.com'
        send_resolved: true
        headers:
          Subject: '[GatewayZ] {{ .GroupLabels.alertname }} - {{ .GroupLabels.severity | toUpper }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .header { background: #f4f4f4; padding: 20px; border-bottom: 3px solid #007bff; }
              .alert { margin: 20px 0; padding: 15px; border-left: 4px solid #ffc107; background: #fff3cd; }
              .alert.critical { border-color: #dc3545; background: #f8d7da; }
              .alert.warning { border-color: #ffc107; background: #fff3cd; }
              .details { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
              .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
              a { color: #007bff; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üö® GatewayZ Alert</h1>
              <p><strong>Status:</strong> {{ .Status | toUpper }}</p>
              <p><strong>Time:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
            </div>
            
            {{ range .Alerts }}
            <div class="alert {{ .Labels.severity }}">
              <h2>{{ .Labels.alertname }}</h2>
              <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
              <p><strong>Description:</strong> {{ .Annotations.description }}</p>
              
              <div class="details">
                <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
                <p><strong>Component:</strong> {{ .Labels.component }}</p>
                {{ if .Annotations.dashboard }}
                <p><strong>Dashboard:</strong> <a href="{{ .Annotations.dashboard }}">View Dashboard</a></p>
                {{ end }}
                <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
                {{ if .EndsAt }}
                <p><strong>Ended:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}</p>
                {{ end }}
              </div>
            </div>
            {{ end }}
            
            <div class="footer">
              <p>This is an automated alert from GatewayZ Monitoring System.</p>
              <p>For more details, visit <a href="http://localhost:3000">Grafana Dashboard</a></p>
            </div>
          </body>
          </html>
  
  # Critical alerts - urgent attention needed
  - name: 'email-critical'
    email_configs:
      - to: 'manjeshprasad21@gmail.com'
        send_resolved: true
        headers:
          Subject: 'üö® [CRITICAL] GatewayZ Alert: {{ .GroupLabels.alertname }}'
          Priority: 'urgent'
          X-Priority: '1'
        html: |
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="background: #dc3545; color: white; padding: 20px; border-radius: 4px;">
              <h1>üö® CRITICAL ALERT</h1>
              <p style="font-size: 18px; margin: 0;"><strong>{{ .GroupLabels.alertname }}</strong></p>
            </div>
            
            {{ range .Alerts }}
            <div style="margin: 20px 0; padding: 15px; border-left: 4px solid #dc3545; background: #f8d7da;">
              <h2>{{ .Annotations.summary }}</h2>
              <p>{{ .Annotations.description }}</p>
              
              {{ if .Annotations.dashboard }}
              <p><a href="{{ .Annotations.dashboard }}" style="color: #007bff;">View Dashboard ‚Üí</a></p>
              {{ end }}
              
              <p style="margin-top: 15px; font-size: 12px; color: #666;">
                Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
              </p>
            </div>
            {{ end }}
            
            <p style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
              Immediate action required. Visit <a href="http://localhost:3000">Grafana Dashboard</a> for details.
            </p>
          </body>
          </html>
  
  # Model health alerts - health score issues
  - name: 'email-model-health'
    email_configs:
      - to: 'manjeshprasad21@gmail.com'
        send_resolved: true
        headers:
          Subject: '‚ö†Ô∏è [MODEL HEALTH] GatewayZ Alert: {{ .GroupLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="background: #ffc107; color: #333; padding: 20px; border-radius: 4px;">
              <h1>‚ö†Ô∏è Model Health Alert</h1>
              <p style="font-size: 18px; margin: 0;"><strong>{{ .GroupLabels.alertname }}</strong></p>
            </div>
            
            {{ range .Alerts }}
            <div style="margin: 20px 0; padding: 15px; border-left: 4px solid #ffc107; background: #fff3cd;">
              <h2>{{ .Annotations.summary }}</h2>
              <p>{{ .Annotations.description }}</p>
              
              {{ if .Annotations.dashboard }}
              <p><a href="{{ .Annotations.dashboard }}" style="color: #007bff;">View Model Performance Dashboard ‚Üí</a></p>
              {{ end }}
              
              <p style="margin-top: 15px; font-size: 12px; color: #666;">
                Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
              </p>
            </div>
            {{ end }}
          </body>
          </html>
  
  # Provider health alerts
  - name: 'email-provider-health'
    email_configs:
      - to: 'manjeshprasad21@gmail.com'
        send_resolved: true
        headers:
          Subject: '‚ö†Ô∏è [PROVIDER HEALTH] GatewayZ: {{ .GroupLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="background: #17a2b8; color: white; padding: 20px; border-radius: 4px;">
              <h1>‚ö†Ô∏è Provider Health Alert</h1>
              <p style="font-size: 18px; margin: 0;"><strong>{{ .GroupLabels.alertname }}</strong></p>
            </div>
            
            {{ range .Alerts }}
            <div style="margin: 20px 0; padding: 15px; border-left: 4px solid #17a2b8; background: #d1ecf1;">
              <h2>{{ .Annotations.summary }}</h2>
              <p>{{ .Annotations.description }}</p>
              
              {{ if .Labels.provider }}
              <p><strong>Provider:</strong> {{ .Labels.provider }}</p>
              {{ end }}
              
              {{ if .Annotations.dashboard }}
              <p><a href="{{ .Annotations.dashboard }}" style="color: #007bff;">View Provider Dashboard ‚Üí</a></p>
              {{ end }}
              
              <p style="margin-top: 15px; font-size: 12px; color: #666;">
                Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
              </p>
            </div>
            {{ end }}
          </body>
          </html>

# Inhibition rules - suppress alerts based on other alerts
inhibit_rules:
  # If a critical alert is firing, suppress warning alerts for the same component
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['component', 'alertname']
  
  # If overall health is low, suppress individual provider health alerts
  - source_match:
      alertname: 'LowModelHealthScore'
    target_match:
      alertname: 'LowProviderHealthScore'
    equal: []
