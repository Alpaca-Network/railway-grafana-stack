# ============================================================================
# GatewayZ Alertmanager Configuration
# ============================================================================
#
# This file is processed by entrypoint.sh at container startup.
# Placeholders are substituted from environment variables:
#
#   SMTP_HOST          SMTP server host:port  (default: smtp.gmail.com:465)
#   SMTP_FROM          From address           (required)
#   SMTP_USER          SMTP username          (required)
#   SMTP_PASSWORD      SMTP password / app-password (required)
#   SMTP_STARTTLS      NoStartTLS | MandatoryStartTLS | OpportunisticStartTLS
#   ALERT_EMAIL_OPS    Ops team email(s)      (default: manjeshprasad21@gmail.com,vaughn@alpacanetwork.ai)
#   ALERT_EMAIL_CRIT   Critical-pager email(s)(default: same as ops)
#   EXTERNAL_URL       Public URL of this Alertmanager service (for links in emails)
#
# ============================================================================

global:
  # How long to wait before re-sending an alert that has already been sent.
  resolve_timeout: 5m

  # SMTP ‚Äî all values substituted by entrypoint.sh
  smtp_smarthost:       'SMTP_HOST_PLACEHOLDER'
  smtp_from:            'SMTP_FROM_PLACEHOLDER'
  smtp_auth_username:   'SMTP_USER_PLACEHOLDER'
  smtp_auth_password:   'SMTP_PASSWORD_PLACEHOLDER'
  smtp_require_tls:     false   # entrypoint sets this to true when using STARTTLS

# ============================================================================
# Templates
# ============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ============================================================================
# Routing Tree
# Mirrors the policy structure already in grafana/provisioning/alerting/
# notification_policies.yml so both Grafana Alerting AND Prometheus alerts
# reach the right people.
# ============================================================================
route:
  receiver: ops-email
  group_by:
    - alertname
    - instance

  # Timing defaults for non-matched alerts
  group_wait:      30s
  group_interval:  5m
  repeat_interval: 1h

  routes:
    # ------------------------------------------------------------------
    # CRITICAL ‚Äî immediate, repeat every 15 min
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, instance]
      matchers:
        - name: severity
          value: critical
          matchType: '='
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m
      continue: false

    # ------------------------------------------------------------------
    # SLO burn-rate ‚Äî critical path
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, slo]
      matchers:
        - name: component
          value: slo
          matchType: '='
        - name: severity
          value: critical
          matchType: '='
      group_wait:      0s
      group_interval:  5m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, slo]
      matchers:
        - name: component
          value: slo
          matchType: '='
      group_wait:      5m
      group_interval:  10m
      repeat_interval: 1h

    # ------------------------------------------------------------------
    # Traffic spikes ‚Äî critical (3√ó+ baseline)
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: traffic_spike
          matchType: '='
        - name: severity
          value: critical
          matchType: '='
      group_wait:      10s
      group_interval:  5m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: traffic_spike
          matchType: '='
      group_wait:      30s
      group_interval:  10m
      repeat_interval: 1h

    # ------------------------------------------------------------------
    # Traffic drop
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: traffic_drop
          matchType: '='
      group_wait:      30s
      group_interval:  10m
      repeat_interval: 1h

    # ------------------------------------------------------------------
    # Error rate spike ‚Äî critical
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: error_rate_spike
          matchType: '='
        - name: severity
          value: critical
          matchType: '='
      group_wait:      0s
      group_interval:  3m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: error_rate_spike
          matchType: '='
      group_wait:      30s
      group_interval:  5m
      repeat_interval: 30m

    # ------------------------------------------------------------------
    # Server errors (5xx)
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: server_errors
          matchType: '='
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Latency ‚Äî critical
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: latency_anomaly
          matchType: '='
        - name: severity
          value: critical
          matchType: '='
      group_wait:      10s
      group_interval:  5m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: latency_anomaly
          matchType: '='
      group_wait:      30s
      group_interval:  10m
      repeat_interval: 1h

    - receiver: critical-email
      group_by: [alertname, category]
      matchers:
        - name: category
          value: latency_spike
          matchType: '='
      group_wait:      0s
      group_interval:  3m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Availability / circuit breaker
    # ------------------------------------------------------------------
    - receiver: critical-email
      group_by: [alertname, category, provider]
      matchers:
        - name: category
          value: availability_drop
          matchType: '='
        - name: severity
          value: critical
          matchType: '='
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    - receiver: ops-email
      group_by: [alertname, category, provider]
      matchers:
        - name: category
          value: availability_drop
          matchType: '='
      group_wait:      30s
      group_interval:  5m
      repeat_interval: 30m

    - receiver: critical-email
      group_by: [alertname, provider]
      matchers:
        - name: category
          value: circuit_breaker
          matchType: '='
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    - receiver: critical-email
      group_by: [alertname]
      matchers:
        - name: category
          value: multi_provider_degradation
          matchType: '='
      group_wait:      0s
      group_interval:  5m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Model-level alerts
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, model_id]
      matchers:
        - name: category
          value: model
          matchType: '='
      group_wait:      5m
      group_interval:  5m
      repeat_interval: 30m

    # ------------------------------------------------------------------
    # Backend / infrastructure
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, component]
      matchers:
        - name: category
          value: backend
          matchType: '='
      group_wait:      5m
      group_interval:  5m
      repeat_interval: 30m

    - receiver: critical-email
      group_by: [alertname, job]
      matchers:
        - name: component
          value: infrastructure
          matchType: '='
        - name: severity
          value: critical
          matchType: '='
      group_wait:      0s
      group_interval:  2m
      repeat_interval: 15m

    # ------------------------------------------------------------------
    # Log-based alerts
    # ------------------------------------------------------------------
    - receiver: ops-email
      group_by: [alertname, service]
      matchers:
        - name: category
          value: logs
          matchType: '='
      group_wait:      30s
      group_interval:  5m
      repeat_interval: 30m

# ============================================================================
# Receivers
# ============================================================================
receivers:
  # --------------------------------------------------------------------------
  # ops-email ‚Äî general operational alerts
  # --------------------------------------------------------------------------
  - name: ops-email
    email_configs:
      - to: 'ALERT_EMAIL_OPS_PLACEHOLDER'
        send_resolved: true
        headers:
          Subject: '[GatewayZ] {{ .GroupLabels.alertname }} ‚Äî {{ .Status | toUpper }}'
        html: |
          {{ range .Alerts }}
          <h2>{{ .Labels.alertname }}</h2>
          <p><strong>Status:</strong> {{ .Status }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Category:</strong> {{ .Labels.category }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Starts At:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
          {{ if .GeneratorURL }}<p><a href="{{ .GeneratorURL }}">View in Prometheus</a></p>{{ end }}
          <hr/>
          {{ end }}

  # --------------------------------------------------------------------------
  # critical-email ‚Äî immediate pager-style alerts
  # --------------------------------------------------------------------------
  - name: critical-email
    email_configs:
      - to: 'ALERT_EMAIL_CRIT_PLACEHOLDER'
        send_resolved: true
        headers:
          Subject: 'üö® [GatewayZ CRITICAL] {{ .GroupLabels.alertname }} ‚Äî {{ .Status | toUpper }}'
        html: |
          <h1 style="color:red">üö® CRITICAL ALERT</h1>
          {{ range .Alerts }}
          <h2>{{ .Labels.alertname }}</h2>
          <p><strong>Status:</strong> {{ .Status }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Category:</strong> {{ .Labels.category }}</p>
          <p><strong>Provider:</strong> {{ .Labels.provider }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Runbook:</strong> {{ .Annotations.runbook_url }}</p>
          <p><strong>Starts At:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
          {{ if .GeneratorURL }}<p><a href="{{ .GeneratorURL }}">üîç View in Prometheus</a></p>{{ end }}
          <hr/>
          {{ end }}

# ============================================================================
# Inhibition Rules
# Suppress lower-severity alerts when a critical alert already firing
# ============================================================================
inhibit_rules:
  # Suppress warning when critical is firing for same alertname + instance
  - source_matchers:
      - name: severity
        value: critical
        matchType: '='
    target_matchers:
      - name: severity
        value: warning
        matchType: '='
    equal: [alertname, instance]

  # Suppress individual provider alerts when multi-provider degradation fires
  - source_matchers:
      - name: category
        value: multi_provider_degradation
        matchType: '='
    target_matchers:
      - name: category
        value: availability_drop
        matchType: '='
    equal: []
